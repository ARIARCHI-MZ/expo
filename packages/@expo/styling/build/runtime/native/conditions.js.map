{"version":3,"file":"conditions.js","sourceRoot":"","sources":["../../../src/runtime/native/conditions.ts"],"names":[],"mappings":"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","sourcesContent":["import {\n  MediaCondition,\n  MediaFeature,\n  MediaFeatureComparison,\n  MediaFeatureValue,\n  MediaQuery,\n} from \"lightningcss\";\n\nimport { exhaustiveCheck } from \"../../css-to-rn/utils\";\nimport {\n  ContainerRuntime,\n  ExtractedContainerQuery,\n  Interaction,\n  PseudoClassesQuery,\n  SignalLike,\n} from \"../../types\";\nimport { colorScheme, isReduceMotionEnabled, vh, vw } from \"./globals\";\n\ninterface ConditionReference {\n  width: number | SignalLike<number>;\n  height: number | SignalLike<number>;\n}\n\nconst defaultConditionReference: ConditionReference = {\n  width: vw,\n  height: vh,\n};\n\n/**\n * Test a media query against current conditions\n */\nexport function testMediaQuery(\n  mediaQuery: MediaQuery,\n  conditionReference: ConditionReference = defaultConditionReference\n) {\n  const pass = testCondition(mediaQuery.condition, conditionReference);\n  return mediaQuery.qualifier === \"not\" ? !pass : pass;\n}\n\nexport function testPseudoClasses(\n  interaction: Interaction | undefined,\n  meta: PseudoClassesQuery\n) {\n  if (meta.active && !interaction?.active.get()) return false;\n  if (meta.hover && !interaction?.hover.get()) return false;\n  if (meta.focus && !interaction?.focus.get()) return false;\n  return true;\n}\n\nexport function testContainerQuery(\n  containerQuery: ExtractedContainerQuery[] | undefined,\n  containers: Record<string, ContainerRuntime> = {}\n) {\n  // If there is no query, we passed\n  if (!containerQuery || containerQuery.length === 0) {\n    return true;\n  }\n\n  return containerQuery.every((query) => {\n    // If the query has a name, but the container doesn't exist, we failed\n    if (query.name && !containers[query.name]) return false;\n\n    // If the query has a name, we use the container with that name\n    // Otherwise default to the last container\n    const container = query.name\n      ? containers[query.name]\n      : containers.__default;\n\n    // We failed if the container doesn't exist (e.g no default container)\n    if (!container) return false;\n\n    if (\n      query.pseudoClasses &&\n      !testPseudoClasses(container.interaction, query.pseudoClasses)\n    ) {\n      return false;\n    }\n\n    // If there is no condition, we passed (maybe only named as specified)\n    if (!query.condition) return true;\n\n    return testCondition(query.condition, {\n      width: container.interaction.layout.width,\n      height: container.interaction.layout.height,\n    });\n  });\n}\n\n/**\n * Test a media condition against current conditions\n * This is also used for container queries\n */\nexport function testCondition(\n  condition: MediaCondition | null | undefined,\n  conditionReference: ConditionReference\n): boolean {\n  if (!condition) return true;\n\n  if (condition.type === \"operation\") {\n    if (condition.operator === \"and\") {\n      return condition.conditions.every((c) =>\n        testCondition(c, conditionReference)\n      );\n    } else {\n      return condition.conditions.some((c) =>\n        testCondition(c, conditionReference)\n      );\n    }\n  } else if (condition.type === \"not\") {\n    return !testCondition(condition.value, conditionReference);\n  }\n\n  return testFeature(condition.value, conditionReference);\n}\n\nfunction testFeature(\n  feature: MediaFeature,\n  conditionReference: ConditionReference\n) {\n  switch (feature.type) {\n    case \"plain\":\n      return testPlainFeature(feature, conditionReference);\n    case \"range\":\n      return testRange(feature, conditionReference);\n    case \"boolean\":\n      return testBoolean(feature);\n    case \"interval\":\n      return false;\n    default:\n      exhaustiveCheck(feature);\n  }\n\n  return false;\n}\n\nfunction testPlainFeature(\n  feature: Extract<MediaFeature, { type: \"plain\" }>,\n  ref: ConditionReference\n) {\n  const value = getMediaFeatureValue(feature.value);\n\n  if (value === null) {\n    return false;\n  }\n\n  switch (feature.name) {\n    case \"prefers-color-scheme\":\n      return colorScheme.get() === value;\n    case \"width\":\n      return testComparision(\"equal\", ref.width, value);\n    case \"min-width\":\n      return testComparision(\"greater-than-equal\", ref.width, value);\n    case \"max-width\":\n      return testComparision(\"less-than-equal\", ref.width, value);\n    case \"height\":\n      return testComparision(\"equal\", ref.height, value);\n    case \"min-height\":\n      return testComparision(\"greater-than-equal\", ref.height, value);\n    case \"max-height\":\n      return testComparision(\"less-than-equal\", ref.height, value);\n    default:\n      return false;\n  }\n}\n\nfunction getMediaFeatureValue(value: MediaFeatureValue) {\n  if (value.type === \"number\") {\n    return value.value;\n  } else if (value.type === \"length\") {\n    if (value.value.type === \"value\") {\n      if (value.value.value.unit === \"px\") {\n        return value.value.value.value;\n      } else {\n        return null;\n      }\n    } else {\n      return null;\n    }\n  } else if (value.type === \"ident\") {\n    return value.value;\n  }\n\n  return null;\n}\n\nfunction testRange(\n  feature: Extract<MediaFeature, { type: \"range\" }>,\n  ref: ConditionReference\n) {\n  const value = getMediaFeatureValue(feature.value);\n\n  if (value === null || typeof value !== \"number\") {\n    return false;\n  }\n\n  /*eslint no-fallthrough: [\"error\", { \"commentPattern\": \"break[\\\\s\\\\w]*omitted\" }]*/\n  switch (feature.name) {\n    case \"height\":\n      return testComparision(feature.operator, ref.height, value);\n    case \"width\":\n      return testComparision(feature.operator, ref.width, value);\n  }\n\n  return false;\n}\n\nfunction testComparision(\n  comparision: MediaFeatureComparison,\n  ref: number | SignalLike<number>,\n  value: unknown\n) {\n  if (typeof value !== \"number\") return false;\n  switch (comparision) {\n    case \"equal\":\n      return unwrap(ref) === value;\n    case \"greater-than\":\n      return unwrap(ref) > value;\n    case \"greater-than-equal\":\n      return unwrap(ref) >= value;\n    case \"less-than\":\n      return unwrap(ref) < value;\n    case \"less-than-equal\":\n      return unwrap(ref) < value;\n  }\n}\n\nfunction testBoolean(feature: Extract<MediaFeature, { type: \"boolean\" }>) {\n  switch (feature.name) {\n    case \"prefers-reduced-motion\":\n      return isReduceMotionEnabled.get();\n  }\n  return false;\n}\n\nfunction unwrap<T>(value: T | SignalLike<T>): T {\n  return value && typeof value === \"object\" && \"get\" in value\n    ? value.get()\n    : value;\n}\n"]}